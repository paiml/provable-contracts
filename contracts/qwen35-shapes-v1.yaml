metadata:
  version: "1.0.0"
  created: "2026-02-18"
  author: "PAIML Engineering"
  description: "Qwen3.5-9B concrete shape instantiation and RoPE frequency scaling"
  references:
    - "Qwen3.5 Fine-Tune Spec — model configuration"
    - "Su et al. (2021) RoFormer — Rotary Position Embedding"

equations:
  q_projection_shape:
    formula: "[n_h * d_k, hidden] = [16*256, 4096] = [4096, 4096]"
    domain: "Qwen3.5-9B config: n_h=16, d_k=256, hidden=4096"
    invariants:
      - "Q projection is square for this config"
  kv_projection_shape:
    formula: "[n_kv * d_k, hidden] = [4*256, 4096] = [1024, 4096]"
    domain: "Qwen3.5-9B config: n_kv=4, d_k=256"
    invariants:
      - "GQA ratio: n_h / n_kv = 4"
  swiglu_ratio:
    formula: "intermediate / hidden = 12288 / 4096 = 3.0"
    domain: "Qwen3.5-9B config"
    invariants:
      - "Expansion ratio is exactly 3.0"
  o_projection_transpose:
    formula: "shape(o_proj) == transpose(shape(q_proj)) = [hidden, n_h * d_k]"
    domain: "Standard transformer"
    invariants:
      - "O projection reverses Q projection dimensions"
  rope_frequency:
    formula: "freq_i = base^(-2i/d_k) for i in [0, d_k/2)"
    domain: "base = rope_theta, d_k = head_dim"
    invariants:
      - "len(freqs) = d_k / 2"
      - "freq_0 = 1.0"
      - "Strictly decreasing"

proof_obligations:
  - type: invariant
    property: "Q projection shape"
    formal: "n_h * d_k = 4096 for Qwen3.5-9B"
    applies_to: all
  - type: invariant
    property: "KV projection shape"
    formal: "n_kv * d_k = 1024 for Qwen3.5-9B"
    applies_to: all
  - type: invariant
    property: "SwiGLU expansion ratio"
    formal: "12288 / 4096 = 3.0"
    applies_to: all
  - type: invariant
    property: "O projection transpose"
    formal: "shape(o_proj) == reverse(shape(q_proj))"
    applies_to: all
  - type: invariant
    property: "RoPE frequency vector length"
    formal: "len(freqs) == d_k / 2"
    applies_to: all
  - type: monotonicity
    property: "RoPE frequency decreasing"
    formal: "freq_i > freq_{i+1} for all i"
    applies_to: all
  - type: equivalence
    property: "SIMD shape equivalence"
    tolerance: 0.0
    applies_to: simd

falsification_tests:
  - id: FALSIFY-Q35-001
    rule: "Shape instantiation"
    prediction: "Concrete shapes match formula"
    test: "Deterministic test with Qwen3.5 constants"
    if_fails: "Config constant mismatch"
  - id: FALSIFY-Q35-002
    rule: "RoPE frequencies"
    prediction: "Frequencies strictly decrease"
    test: "proptest with random base and head_dim"
    if_fails: "Exponent sign error in frequency formula"

kani_harnesses:
  - id: KANI-Q35-001
    obligation: Q35-INV-001
    property: "Shape consistency for Qwen3.5 config"
    bound: 1
    strategy: exhaustive
    solver: cadical
    harness: verify_qwen35_shapes

qa_gate:
  id: F-Q35-001
  name: "Qwen3.5 Shapes Contract"
  description: "Model shape instantiation quality gate"
  checks:
    - "q_projection"
    - "kv_projection"
    - "swiglu_ratio"
    - "o_projection"
    - "rope_frequencies"
  pass_criteria: "All 6 falsification tests pass + 1 SIMD ignored"
  falsification: "Change n_kv from 4 to 3 to break GQA divisibility"
