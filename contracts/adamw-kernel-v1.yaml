metadata:
  version: "1.0.0"
  created: "2026-02-18"
  author: "PAIML Engineering"
  description: "AdamW kernel â€” Adam optimizer with decoupled weight decay"
  references:
    - "Loshchilov & Hutter (2017) Decoupled Weight Decay Regularization"
    - "Kingma & Ba (2014) Adam: A Method for Stochastic Optimization"

equations:
  adam_moments:
    formula: "m_t = beta1 * m_{t-1} + (1 - beta1) * g_t"
    domain: "g_t in R^d, m_0 = 0, beta1 in (0, 1)"
    codomain: "m_t in R^d"
    invariants:
      - "m_t is exponential moving average of gradients"
      - "|m_t| bounded by max(|g_1|, ..., |g_t|) when beta1 < 1"
  adam_variance:
    formula: "v_t = beta2 * v_{t-1} + (1 - beta2) * g_t^2"
    domain: "g_t in R^d, v_0 = 0, beta2 in (0, 1)"
    codomain: "v_t in R_>=0^d"
    invariants:
      - "v_t >= 0 (non-negative second moment)"
      - "v_t is exponential moving average of squared gradients"
  bias_correction:
    formula: "m_hat_t = m_t / (1 - beta1^t), v_hat_t = v_t / (1 - beta2^t)"
    domain: "t >= 1, beta1 in (0,1), beta2 in (0,1)"
    codomain: "m_hat_t in R^d, v_hat_t in R_>=0^d"
    invariants:
      - "Correction factor > 1 for all t >= 1"
      - "Correction approaches 1 as t -> inf"
  weight_update:
    formula: "theta_t = theta_{t-1} - lr * (m_hat_t / (sqrt(v_hat_t) + eps) + lambda * theta_{t-1})"
    domain: "theta in R^d, lr > 0, lambda >= 0, eps > 0"
    codomain: "theta_t in R^d"
    invariants:
      - "Weight decay applied AFTER Adam update (decoupled)"
      - "Update finite when inputs finite and eps > 0"

proof_obligations:
  - type: invariant
    property: "Decoupled weight decay"
    formal: "Weight decay term is lambda * theta, not lambda * theta in gradient"
    applies_to: all
  - type: bound
    property: "Second moment non-negative"
    formal: "v_t >= 0 for all t and all dimensions"
    applies_to: all
  - type: bound
    property: "Bias-corrected moments finite"
    formal: "m_hat_t and v_hat_t are finite when g_t is finite"
    applies_to: all
  - type: invariant
    property: "Bias correction factor"
    formal: "1 / (1 - beta^t) > 1 for t >= 1 and beta in (0, 1)"
    applies_to: all
  - type: equivalence
    property: "SIMD matches scalar within ULP"
    tolerance: 8.0
    applies_to: simd

kernel_structure:
  phases:
    - name: update_first_moment
      description: "m_t = beta1 * m_{t-1} + (1 - beta1) * g_t"
      invariant: "m_t is linear combination of m_{t-1} and g_t"
    - name: update_second_moment
      description: "v_t = beta2 * v_{t-1} + (1 - beta2) * g_t^2"
      invariant: "v_t >= 0"
    - name: bias_correct
      description: "Compute bias-corrected m_hat and v_hat"
      invariant: "Correction factor > 1"
    - name: adam_step
      description: "Compute lr * m_hat / (sqrt(v_hat) + eps)"
      invariant: "Step is finite when eps > 0"
    - name: weight_decay
      description: "Subtract lr * lambda * theta (decoupled)"
      invariant: "Decay applied to theta, not gradient"

simd_dispatch:
  adamw:
    scalar: adamw_step_scalar
    avx2: adamw_step_avx2
    ptx: adamw_ptx

enforcement:
  decoupled_decay:
    description: "Weight decay must be decoupled from gradient update"
    check: "contract_tests::FALSIFY-AW-001"
    severity: "ERROR"
  moment_positivity:
    description: "Second moment must remain non-negative"
    check: "contract_tests::FALSIFY-AW-002"
    severity: "ERROR"

falsification_tests:
  - id: FALSIFY-AW-001
    rule: "Decoupled weight decay"
    prediction: "AdamW(g, lambda) != Adam(g + lambda*theta) for lambda > 0"
    test: "proptest comparing AdamW vs L2-regularized Adam"
    if_fails: "Weight decay is coupled (L2 reg instead of decoupled)"
  - id: FALSIFY-AW-002
    rule: "Second moment non-negativity"
    prediction: "v_t >= 0 for all t after random gradient updates"
    test: "proptest with 100 random gradient steps"
    if_fails: "Floating-point underflow in EMA update"
  - id: FALSIFY-AW-003
    rule: "Bias correction"
    prediction: "1/(1-beta^t) > 1 for t in [1, 10000] and beta in (0, 1)"
    test: "proptest with random t and beta values"
    if_fails: "Integer overflow in power computation or division by zero"
  - id: FALSIFY-AW-004
    rule: "Update finiteness"
    prediction: "theta_t is finite when g_t is finite and eps > 0"
    test: "proptest with extreme gradients near f32::MIN/MAX"
    if_fails: "Division by near-zero denominator when eps too small"
  - id: FALSIFY-AW-005
    rule: "SIMD equivalence"
    prediction: "|adamw_avx2(args) - adamw_scalar(args)| < 8 ULP"
    test: "proptest comparing scalar vs SIMD full update step"
    if_fails: "SIMD sqrt or reciprocal approximation differs"
  - id: FALSIFY-AW-006
    rule: "Boundary - zero gradient"
    prediction: "With g=0, only weight decay modifies theta"
    test: "proptest with zero gradient, nonzero lambda"
    if_fails: "Bias correction or moment update incorrect at zero"

kani_harnesses:
  - id: KANI-AW-001
    obligation: AW-INV-001
    property: "Weight decay is decoupled from Adam update"
    bound: 4
    strategy: stub_float
    solver: cadical
    harness: verify_adamw_decoupled
  - id: KANI-AW-002
    obligation: AW-BND-001
    property: "Second moment stays non-negative"
    bound: 8
    strategy: stub_float
    solver: cadical
    harness: verify_adamw_moment_positive
  - id: KANI-AW-003
    obligation: AW-BND-002
    property: "Update is finite with positive epsilon"
    bound: 4
    strategy: stub_float
    solver: cadical
    harness: verify_adamw_finite_update

qa_gate:
  id: F-AW-001
  name: "AdamW Contract"
  description: "Decoupled weight decay optimizer quality gate"
  checks:
    - "decoupled_decay"
    - "moment_positivity"
    - "update_finiteness"
    - "simd_equivalence"
  pass_criteria: "All 6 falsification tests pass + Kani harnesses verify"
  falsification: "Move weight decay inside gradient (L2 instead of decoupled)"
