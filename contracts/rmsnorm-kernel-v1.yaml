metadata:
  version: "1.0.0"
  created: "2026-02-18"
  author: "PAIML Engineering"
  description: "RMSNorm kernel — root mean square layer normalization"
  references:
    - "Zhang & Sennrich (2019) Root Mean Square Layer Normalization"
    - "Touvron et al. (2023) Llama 2: Open Foundation and Fine-Tuned Chat Models"

equations:
  rmsnorm:
    formula: "RMSNorm(x)_i = (x_i / RMS(x)) · γ_i where RMS(x) = √(Σ x_i² / n + ε)"
    domain: "x ∈ ℝ^n, γ ∈ ℝ^n, ε > 0"
    codomain: "ℝ^n"
    invariants:
      - "‖RMSNorm(x)‖² / n ≈ ‖γ‖² / n (scale preservation)"
      - "RMSNorm(α·x) = sign(α) · RMSNorm(x) · γ (scale invariance)"

proof_obligations:
  - type: invariant
    property: "Output is finite"
    formal: "|RMSNorm(x)_i| < ∞ for all i when ε > 0"
    applies_to: all
  - type: invariant
    property: "Scale invariance"
    formal: "RMSNorm(α·x) = sign(α) · RMSNorm(x) for α ≠ 0"
    applies_to: all
  - type: bound
    property: "RMS denominator is positive"
    formal: "RMS(x) > 0 when ε > 0"
    applies_to: all
  - type: equivalence
    property: "SIMD matches scalar within ULP"
    tolerance: 4.0
    applies_to: simd
  - type: idempotency
    property: "Normalized RMS ≈ 1"
    formal: "RMS(RMSNorm(x)/γ) ≈ 1 when γ = 1"
    applies_to: all

kernel_structure:
  phases:
    - name: sum_squares
      description: "Compute Σ x_i²"
      invariant: "sum >= 0"
    - name: compute_rms
      description: "Compute √(sum/n + ε)"
      invariant: "rms > 0 when ε > 0"
    - name: normalize_scale
      description: "Compute x_i / rms * γ_i"
      invariant: "output finite when rms > 0"

simd_dispatch:
  rmsnorm:
    scalar: rmsnorm_scalar
    avx2: rmsnorm_avx2

enforcement:
  finiteness:
    description: "Output must always be finite"
    check: "contract_tests::FALSIFY-RN-001"
    severity: "ERROR"
  scale_invariance:
    description: "Must satisfy scale invariance"
    check: "contract_tests::FALSIFY-RN-002"
    severity: "ERROR"

falsification_tests:
  - id: FALSIFY-RN-001
    rule: "Finiteness"
    prediction: "RMSNorm(x) is finite for all finite x when ε > 0"
    test: "proptest with random vectors including near-zero"
    if_fails: "Division by zero when ε too small"
  - id: FALSIFY-RN-002
    rule: "Scale invariance"
    prediction: "RMSNorm(α·x) ≈ sign(α)·RMSNorm(x) for α ≠ 0"
    test: "proptest scaling random vectors by random α"
    if_fails: "Epsilon not scale-invariant in implementation"
  - id: FALSIFY-RN-003
    rule: "SIMD equivalence"
    prediction: "|rmsnorm_avx2(x) - rmsnorm_scalar(x)| < 4 ULP"
    test: "proptest comparing scalar vs SIMD"
    if_fails: "SIMD reduction ordering differs"
  - id: FALSIFY-RN-004
    rule: "Zero vector"
    prediction: "RMSNorm(0) = 0 (output is zero vector)"
    test: "direct test with zero input"
    if_fails: "NaN from 0/ε edge case"
  - id: FALSIFY-RN-005
    rule: "Unit γ normalized RMS"
    prediction: "RMS(RMSNorm(x)/1) ≈ 1 for γ = [1,1,...,1]"
    test: "proptest with unit weight vectors"
    if_fails: "Normalization not producing unit RMS"

kani_harnesses:
  - id: KANI-RN-001
    obligation: RN-INV-001
    property: "Output always finite with ε > 0"
    bound: 16
    strategy: exhaustive
    harness: verify_rmsnorm_finiteness
  - id: KANI-RN-002
    obligation: RN-BND-001
    property: "RMS denominator positive"
    bound: 16
    strategy: exhaustive
    harness: verify_rms_positive

qa_gate:
  id: F-RN-001
  name: "RMSNorm Contract"
  description: "Root mean square normalization quality gate"
  checks:
    - "finiteness"
    - "scale_invariance"
    - "simd_equivalence"
  pass_criteria: "All 5 falsification tests pass + Kani harnesses verify"
  falsification: "Set ε = 0 to trigger division by zero"
